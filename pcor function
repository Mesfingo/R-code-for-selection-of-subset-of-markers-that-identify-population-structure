#make sure plink is in your working directory
#phenotype goes into s which should have two columns which contain IDs(1st) and phenotype/breed composition (2nd) 

pcor<- function (g = "250k", s = str_res, tp = 1, ts) {
  #perform PCA on data
  system(paste("plink","-cow", "-file", g, "-pca","-maf 0.1", "-geno 0.1", "-mind 0.1", "-out", "pca")) 
  ev<-read.table("pca.eigenvec", header = F)
  eva<-read.table("pca.eigenval", header = F)
  
  #Perform GWA for a given number of top PC and rank SNP according to -log(p) and eval
  marker_lists<-lapply(1:tp, function(x) {
    write.table(ev[, c(1, 2, 2+x)], "pheno.txt", row.names = F, col.names = F, 
                quote = F, sep = " ") # writing a phenotype file to input into plink
    tname<-paste("asso", x, sep="") # making a temporary name for plink output file
    system(paste("plink","-cow", "-file", g, "-assoc", "-pheno", "pheno.txt", 
                 "-allow-no-sex", "-out", tname)) #performing GWA with selected PC as a response and putting result in tname
    return(read.table(paste(tname, ".qassoc", sep = ""), header = T)[,c(2,9)]) # relevant parts of GWA result (SNP id & p-values) 
    
  })
  
  p<-as.data.frame(marker_lists)
  
  if(ncol(p)>2) {p<-p[,-(seq(3, ncol(p), by = 2))]}  # if more than one PC was used, get rid of redundant columns (snp IDs)
  
  write.table(p, "pval_assoc.txt", row.names = F, quote = F, sep = " ")
  
  p[,2:(tp+1)]<- log10(p[,2:(tp+1)])*-1   #change row p-values into -logs
  
  
  y<- sapply(1:nrow(p), function (x) {  # make y, a value to rank SNP based on -log(p-val) wighted by eigenvector for corresponding PC
    sum((p[x, 2:(tp + 1)]) * eva[,1][1:tp])
  })    
  
  z<- data.frame(p[,1], y)   #z is a data frame with marker names and their associated y value

   z<- z[order(z[,2], decreasing = T), ]  #reordering z based on values of y
  
 
  topsnp<- z[1:ts, 1]    # extract 'ts' amount of top SNP ranked based on y
  write.table(topsnp, file = "topsnp.txt", 
              row.names = F, col.names = F, sep = " ", quote = F)   #write top selected markers into a file for plink to read
  
  
  system(paste("plink","-cow", "-file", g, "-pca", "-extract", "topsnp.txt", 
               "-mind", "-out", "rpca"))   #perform pca using selected snp with plink
  ev2<-read.table("rpca.eigenvec", header = F)
  
  
  standard<-sapply(ev2[,2], function(x) {
    s[s[, 1] == x, 2]})   #make sure the 'phenotype' value supplied by 's' as an argument has IDs that correspond with one in plink output
  return(cor(standard, ev2[,3], use = "complete.obs", method = "pearson"))
  
}
